"use strict";var themes=require("../themes"),tools=require("../tools"),_=require("lodash"),chalk=require("chalk"),needle=require("needle"),noon=require("noon"),CFILE=process.env.HOME+"/.leximaven.noon";exports.command="onelook <word>",exports.desc="Onelook definitions",exports.builder={out:{alias:"o",desc:"Write cson, json, noon, plist, yaml, xml","default":"",type:"string"},force:{alias:"f",desc:"Force overwriting outfile","default":!1,type:"boolean"},save:{alias:"s",desc:"Save flags to config file","default":!1,type:"boolean"},links:{alias:"l",desc:"Include resource links","default":!1,type:"boolean"}},exports.handler=function(e){tools.checkConfig(CFILE);var o=noon.load(CFILE),l={onelook:{links:e.l}};o.prefer&&(o=_.merge({},o,l));var n=themes.loadTheme(o.theme);o.verbose&&themes.labelDown("Onelook",n,null);var r="http://onelook.com/?xml=1&w="+e.word;r=encodeURI(r);var s={type:"onelook",source:"http://www.onelook.com"},a=_.get(chalk,n.content.style);needle.get(r,function(l,r){if(l||200!==r.statusCode)console.error(chalk.red.bold("HTTP "+r.statusCode+":")+" "+chalk.red(l));else{var t=r.body,i=t.OLResponse,c=i.OLPhrases,d=i.OLSimilar,f=i.OLQuickDef,h=i.OLRes;if(themes.labelDown("Definition",n,null),Array.isArray(f))for(var u=0;u<=f.length-1;u++){var m=f[u];m=m.replace(/&lt;|&gt;|\n|\/i/g,""),m=m.replace(/i"/g,'"'),console.log(a(m)),s[["definition"+u]]=m}else{var p=f.replace(/&lt;|&gt;|\n|\/i/g,"");console.log(a(p)),s.definition=p}if(c){var g=c.replace(/\n/g,"");themes.labelDown("Phrases",n,g),s.phrase=g}if(d){var k=d.replace(/\n/g,"");themes.labelDown("Similar",n,k),s.sim=k}if(o.onelook.links){themes.labelDown("Resources",n,null);for(var v=0;v<=h.length-1;v++){var b=h[v],w=b.OLResName.replace(/\n/g,""),L=b.OLResLink.replace(/\n/g,"");themes.labelRight(w,n,L),s[["res"+v]]=w,s[["link"+v]]=L}}e.o&&tools.outFile(e.o,e.f,s),e.s&&o.prefer&&noon.save(CFILE,o)}})};