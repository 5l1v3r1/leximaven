"use strict";var themes=require("../../themes"),tools=require("../../tools"),_=require("lodash"),chalk=require("chalk"),needle=require("needle"),noon=require("noon"),CFILE=process.env.HOME+"/.leximaven.noon";exports.command="define <word>",exports.desc="Wordnik definitions",exports.builder={out:{alias:"o",desc:"Write cson, json, noon, plist, yaml, xml","default":"",type:"string"},force:{alias:"f",desc:"Force overwriting outfile","default":!1,type:"boolean"},save:{alias:"s",desc:"Save flags to config file","default":!1,type:"boolean"},limit:{alias:"l",desc:"Limit number of results","default":5,type:"number"},canon:{alias:"c",desc:"Use canonical","default":!1,type:"boolean"},defdict:{alias:"d",desc:"CSV list of dictionaries or 'all'","default":"all",type:"string"},part:{alias:"p",desc:"CSV list of parts of speech. See http://developer.wordnik.com/docs.html for list of parts.","default":"",type:"string"}},exports.handler=function(e){tools.checkConfig(CFILE);var o=noon.load(CFILE),t={define:{canon:e.c,limit:e.l,defdict:e.d,part:e.p}};o.prefer&&(o=_.merge({},o,t));var s=themes.loadTheme(o.theme);o.verbose&&themes.labelDown("Wordnik",s,null);var i=e.word,n="definitions",r="http://api.wordnik.com:80/v4/word.json/",a=process.env.WORDNIK,l=""+r+i+"/"+n+"?",c=[];c.push("useCanonical="+o.define.canon+"&"),c.push("sourceDictionaries="+o.define.defdict+"&"),c.push("includeRelated=false&"),c.push("includeTags=false&"),c.push("limit="+o.define.limit+"&"),c.push("partOfSpeech="+o.define.part+"&"),c.push("api_key="+a);var d=c.join(""),p=""+l+d;p=encodeURI(p);var f={type:"definition",source:"http://www.wordnik.com"},u=_.get(chalk,s.connector.style),h=_.get(chalk,s.content.style),m=_.get(chalk,s.content.style+".underline"),v=u(s.connector.str);needle.get(p,function(t,i){if(t||200!==i.statusCode)console.error(chalk.red.bold("HTTP "+i.statusCode+":")+" "+chalk.red(t));else{for(var n=i.body,r=0;r<=n.length-1;r++){var a=n[r],l=[];l.push(h(a.text+" ")),l.push(m(a.partOfSpeech)),l.push(v),l.push(h(a.sourceDictionary)),themes.labelRight("Definition",s,l.join("")),f[["text"+r]]=a.text,f[["deftype"+r]]=a.partOfSpeech,f[["source"+r]]=a.sourceDictionary}e.o&&tools.outFile(e.o,e.f,f),e.s&&o.prefer&&noon.save(CFILE,o)}})};