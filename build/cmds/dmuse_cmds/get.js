'use strict';

/* eslint max-len:0 */
var themes = require('../../themes');
var tools = require('../../tools');

var _ = require('lodash');
var chalk = require('chalk');
var moment = require('moment');
var needle = require('needle');
var noon = require('noon');

var CFILE = process.env.HOME + '/.leximaven.noon';

exports.command = 'get <condition>';
exports.desc = 'Datamuse query';
exports.builder = {
  out: {
    alias: 'o',
    desc: 'Write cson, json, noon, plist, yaml, xml',
    default: '',
    type: 'string'
  },
  force: {
    alias: 'f',
    desc: 'Force overwriting outfile',
    default: false,
    type: 'boolean'
  },
  save: {
    alias: 's',
    desc: 'Save flags to config file',
    default: false,
    type: 'boolean'
  },
  max: {
    alias: 'm',
    desc: 'Maximum number of results, 1 to 1000',
    default: 5,
    type: 'number'
  }
};
exports.handler = function (argv) {
  tools.checkConfig(CFILE);
  var config = noon.load(CFILE);
  var proceed = false;
  var stamp = new Date(config.dmuse.date.stamp);
  var now = new Date();
  var diff = moment(now).diff(stamp, 'hours');
  var reset = 24 - diff;
  if (diff < 24) {
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  } else if (diff >= 24) {
    config.dmuse.date.stamp = moment().format();
    config.dmuse.date.remain = config.dmuse.date.limit;
    console.log(chalk.white('Reset API limit to ' + config.dmuse.date.limit + '/' + config.dmuse.date.interval + '.'));
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  }
  if (config.dmuse.date.remain === 0) {
    proceed = false;
  } else if (config.dmuse.date.remain < 0) {
    proceed = false;
    config.dmuse.date.remain = 0;
    noon.save(CFILE, config);
  } else {
    proceed = true;
  }
  if (proceed) {
    (function () {
      var userConfig = {
        dmuse: {
          max: argv.m
        }
      };
      if (config.merge) config = _.merge({}, config, userConfig);
      var theme = themes.loadTheme(config.theme);
      if (config.verbose) themes.labelDown('Datamuse', theme, null);
      var ccont = [];
      ccont.push(argv.condition);
      if (argv._.length > 1) {
        for (var i = 1; i <= argv._.length - 1; i++) {
          ccont.push(argv._[i]);
        }
      }
      var prefix = 'http://api.datamuse.com/words?';
      var conditions = 'max=' + config.dmuse.max + '&';
      _.each(ccont, function (value) {
        conditions = conditions + '&' + value;
      });
      var url = '' + prefix + conditions;
      url = encodeURI(url);
      var tags = {
        n: 'noun',
        adj: 'adjective',
        adv: 'adverb',
        syn: 'synonym'
      };
      var tofile = { type: 'datamuse', source: 'http://datamuse.com/api' };
      var ctstyle = _.get(chalk, theme.content.style);
      needle.get(url, function (error, response) {
        if (!error && response.statusCode === 200) {
          var resp = response.body;
          for (var _i = 0; _i <= resp.length - 1; _i++) {
            var item = resp[_i];
            themes.labelRight('Match', theme, item.word + ' ');
            tofile[['match' + _i]] = item.word;
            if (item.tags !== undefined && item.tags !== []) {
              themes.labelRight('Tags', theme, null);
              for (var j = 0; j <= item.tags.length - 1; j++) {
                if (j === item.tags.length - 1) {
                  process.stdout.write(ctstyle('' + tags[item.tags[j]]));
                  tofile[['tags' + j]] = tags[item.tags[j]];
                } else {
                  process.stdout.write(ctstyle(tags[item.tags[j]] + ', '));
                }
              }
              console.log('');
            }
          }
          if (argv.o) tools.outFile(argv.o, argv.f, tofile);
          if (argv.s && config.merge) noon.save(CFILE, config);
          if (argv.s && !config.merge) console.err(chalk.red('Set option merge to true!'));
          console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today, will reset in ' + reset + ' hours.');
        } else {
          console.error(chalk.red.bold('HTTP ' + response.statusCode + ':') + ' ' + chalk.red(error));
        }
      });
    })();
  } else {
    console.error(chalk.red('Reached today\'s usage limit of ' + config.dmuse.date.limit + '.'));
    process.exit(1);
  }
};
//# sourceMappingURL=data:application/json;base64,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LEtBQWYsQ0FBcUIsUUFBVyxLQUFLLEtBQUssSUFBTCxDQUFVLENBQVYsQ0FBTCxDQUFYLFFBQXJCO0FBQ0Q7QUFDRjtBQUNELHNCQUFRLEdBQVIsQ0FBWSxFQUFaO0FBQ0Q7QUFDRjtBQUNELGNBQUksS0FBSyxDQUFULEVBQVksTUFBTSxPQUFOLENBQWMsS0FBSyxDQUFuQixFQUFzQixLQUFLLENBQTNCLEVBQThCLE1BQTlCO0FBQ1osY0FBSSxLQUFLLENBQUwsSUFBVSxPQUFPLEtBQXJCLEVBQTRCLEtBQUssSUFBTCxDQUFVLEtBQVYsRUFBaUIsTUFBakI7QUFDNUIsY0FBSSxLQUFLLENBQUwsSUFBVSxDQUFDLE9BQU8sS0FBdEIsRUFBNkIsUUFBUSxHQUFSLENBQVksTUFBTSxHQUFOLENBQVUsMkJBQVYsQ0FBWjtBQUM3QixrQkFBUSxHQUFSLENBQWUsT0FBTyxLQUFQLENBQWEsSUFBYixDQUFrQixNQUFqQyxTQUEyQyxPQUFPLEtBQVAsQ0FBYSxJQUFiLENBQWtCLEtBQTdELGlEQUE4RyxLQUE5RztBQUNELFNBdkJELE1BdUJPO0FBQ0wsa0JBQVEsS0FBUixDQUFpQixNQUFNLEdBQU4sQ0FBVSxJQUFWLFdBQXVCLFNBQVMsVUFBaEMsT0FBakIsU0FBbUUsTUFBTSxHQUFOLENBQVUsS0FBVixDQUFuRTtBQUNEO0FBQ0YsT0EzQkQ7QUEvQlc7QUEyRFosR0EzREQsTUEyRE87QUFDTCxZQUFRLEtBQVIsQ0FBYyxNQUFNLEdBQU4sc0NBQTRDLE9BQU8sS0FBUCxDQUFhLElBQWIsQ0FBa0IsS0FBOUQsT0FBZDtBQUNBLFlBQVEsSUFBUixDQUFhLENBQWI7QUFDRDtBQUNGLENBMUZEIiwiZmlsZSI6ImNtZHMvZG11c2VfY21kcy9nZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQgbWF4LWxlbjowICovXG5jb25zdCB0aGVtZXMgPSByZXF1aXJlKCcuLi8uLi90aGVtZXMnKVxuY29uc3QgdG9vbHMgPSByZXF1aXJlKCcuLi8uLi90b29scycpXG5cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxuY29uc3QgbmVlZGxlID0gcmVxdWlyZSgnbmVlZGxlJylcbmNvbnN0IG5vb24gPSByZXF1aXJlKCdub29uJylcblxuY29uc3QgQ0ZJTEUgPSBgJHtwcm9jZXNzLmVudi5IT01FfS8ubGV4aW1hdmVuLm5vb25gXG5cbmV4cG9ydHMuY29tbWFuZCA9ICdnZXQgPGNvbmRpdGlvbj4nXG5leHBvcnRzLmRlc2MgPSAnRGF0YW11c2UgcXVlcnknXG5leHBvcnRzLmJ1aWxkZXIgPSB7XG4gIG91dDoge1xuICAgIGFsaWFzOiAnbycsXG4gICAgZGVzYzogJ1dyaXRlIGNzb24sIGpzb24sIG5vb24sIHBsaXN0LCB5YW1sLCB4bWwnLFxuICAgIGRlZmF1bHQ6ICcnLFxuICAgIHR5cGU6ICdzdHJpbmcnLFxuICB9LFxuICBmb3JjZToge1xuICAgIGFsaWFzOiAnZicsXG4gICAgZGVzYzogJ0ZvcmNlIG92ZXJ3cml0aW5nIG91dGZpbGUnLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgfSxcbiAgc2F2ZToge1xuICAgIGFsaWFzOiAncycsXG4gICAgZGVzYzogJ1NhdmUgZmxhZ3MgdG8gY29uZmlnIGZpbGUnLFxuICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgfSxcbiAgbWF4OiB7XG4gICAgYWxpYXM6ICdtJyxcbiAgICBkZXNjOiAnTWF4aW11bSBudW1iZXIgb2YgcmVzdWx0cywgMSB0byAxMDAwJyxcbiAgICBkZWZhdWx0OiA1LFxuICAgIHR5cGU6ICdudW1iZXInLFxuICB9LFxufVxuZXhwb3J0cy5oYW5kbGVyID0gKGFyZ3YpID0+IHtcbiAgdG9vbHMuY2hlY2tDb25maWcoQ0ZJTEUpXG4gIGxldCBjb25maWcgPSBub29uLmxvYWQoQ0ZJTEUpXG4gIGxldCBwcm9jZWVkID0gZmFsc2VcbiAgY29uc3Qgc3RhbXAgPSBuZXcgRGF0ZShjb25maWcuZG11c2UuZGF0ZS5zdGFtcClcbiAgY29uc3Qgbm93ID0gbmV3IERhdGVcbiAgY29uc3QgZGlmZiA9IG1vbWVudChub3cpLmRpZmYoc3RhbXAsICdob3VycycpXG4gIGNvbnN0IHJlc2V0ID0gMjQgLSBkaWZmXG4gIGlmIChkaWZmIDwgMjQpIHtcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH0gZWxzZSBpZiAoZGlmZiA+PSAyNCkge1xuICAgIGNvbmZpZy5kbXVzZS5kYXRlLnN0YW1wID0gbW9tZW50KCkuZm9ybWF0KClcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSBjb25maWcuZG11c2UuZGF0ZS5saW1pdFxuICAgIGNvbnNvbGUubG9nKGNoYWxrLndoaXRlKGBSZXNldCBBUEkgbGltaXQgdG8gJHtjb25maWcuZG11c2UuZGF0ZS5saW1pdH0vJHtjb25maWcuZG11c2UuZGF0ZS5pbnRlcnZhbH0uYCkpXG4gICAgY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID0gY29uZmlnLmRtdXNlLmRhdGUucmVtYWluIC0gMVxuICAgIG5vb24uc2F2ZShDRklMRSwgY29uZmlnKVxuICB9XG4gIGlmIChjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPT09IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgfSBlbHNlIGlmIChjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPCAwKSB7XG4gICAgcHJvY2VlZCA9IGZhbHNlXG4gICAgY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID0gMFxuICAgIG5vb24uc2F2ZShDRklMRSwgY29uZmlnKVxuICB9IGVsc2Uge1xuICAgIHByb2NlZWQgPSB0cnVlXG4gIH1cbiAgaWYgKHByb2NlZWQpIHtcbiAgICBjb25zdCB1c2VyQ29uZmlnID0ge1xuICAgICAgZG11c2U6IHtcbiAgICAgICAgbWF4OiBhcmd2Lm0sXG4gICAgICB9LFxuICAgIH1cbiAgICBpZiAoY29uZmlnLm1lcmdlKSBjb25maWcgPSBfLm1lcmdlKHt9LCBjb25maWcsIHVzZXJDb25maWcpXG4gICAgY29uc3QgdGhlbWUgPSB0aGVtZXMubG9hZFRoZW1lKGNvbmZpZy50aGVtZSlcbiAgICBpZiAoY29uZmlnLnZlcmJvc2UpIHRoZW1lcy5sYWJlbERvd24oJ0RhdGFtdXNlJywgdGhlbWUsIG51bGwpXG4gICAgY29uc3QgY2NvbnQgPSBbXVxuICAgIGNjb250LnB1c2goYXJndi5jb25kaXRpb24pXG4gICAgaWYgKGFyZ3YuXy5sZW5ndGggPiAxKSB7XG4gICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhcmd2Ll8ubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICAgIGNjb250LnB1c2goYXJndi5fW2ldKVxuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBwcmVmaXggPSAnaHR0cDovL2FwaS5kYXRhbXVzZS5jb20vd29yZHM/J1xuICAgIGxldCBjb25kaXRpb25zID0gYG1heD0ke2NvbmZpZy5kbXVzZS5tYXh9JmBcbiAgICBfLmVhY2goY2NvbnQsICh2YWx1ZSkgPT4ge1xuICAgICAgY29uZGl0aW9ucyA9IGAke2NvbmRpdGlvbnN9JiR7dmFsdWV9YFxuICAgIH0pXG4gICAgbGV0IHVybCA9IGAke3ByZWZpeH0ke2NvbmRpdGlvbnN9YFxuICAgIHVybCA9IGVuY29kZVVSSSh1cmwpXG4gICAgY29uc3QgdGFncyA9IHtcbiAgICAgIG46ICdub3VuJyxcbiAgICAgIGFkajogJ2FkamVjdGl2ZScsXG4gICAgICBhZHY6ICdhZHZlcmInLFxuICAgICAgc3luOiAnc3lub255bScsXG4gICAgfVxuICAgIGNvbnN0IHRvZmlsZSA9IHsgdHlwZTogJ2RhdGFtdXNlJywgc291cmNlOiAnaHR0cDovL2RhdGFtdXNlLmNvbS9hcGknIH1cbiAgICBjb25zdCBjdHN0eWxlID0gXy5nZXQoY2hhbGssIHRoZW1lLmNvbnRlbnQuc3R5bGUpXG4gICAgbmVlZGxlLmdldCh1cmwsIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIGlmICghZXJyb3IgJiYgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSByZXNwb25zZS5ib2R5XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHJlc3AubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHJlc3BbaV1cbiAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnTWF0Y2gnLCB0aGVtZSwgYCR7aXRlbS53b3JkfSBgKVxuICAgICAgICAgIHRvZmlsZVtbYG1hdGNoJHtpfWBdXSA9IGl0ZW0ud29yZFxuICAgICAgICAgIGlmIChpdGVtLnRhZ3MgIT09IHVuZGVmaW5lZCAmJiBpdGVtLnRhZ3MgIT09IFtdKSB7XG4gICAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnVGFncycsIHRoZW1lLCBudWxsKVxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gaXRlbS50YWdzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgICAgICAgICBpZiAoaiA9PT0gaXRlbS50YWdzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjdHN0eWxlKGAke3RhZ3NbaXRlbS50YWdzW2pdXX1gKSlcbiAgICAgICAgICAgICAgICB0b2ZpbGVbW2B0YWdzJHtqfWBdXSA9IHRhZ3NbaXRlbS50YWdzW2pdXVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGN0c3R5bGUoYCR7dGFnc1tpdGVtLnRhZ3Nbal1dfSwgYCkpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCcnKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJndi5vKSB0b29scy5vdXRGaWxlKGFyZ3YubywgYXJndi5mLCB0b2ZpbGUpXG4gICAgICAgIGlmIChhcmd2LnMgJiYgY29uZmlnLm1lcmdlKSBub29uLnNhdmUoQ0ZJTEUsIGNvbmZpZylcbiAgICAgICAgaWYgKGFyZ3YucyAmJiAhY29uZmlnLm1lcmdlKSBjb25zb2xlLmVycihjaGFsay5yZWQoJ1NldCBvcHRpb24gbWVyZ2UgdG8gdHJ1ZSEnKSlcbiAgICAgICAgY29uc29sZS5sb2coYCR7Y29uZmlnLmRtdXNlLmRhdGUucmVtYWlufS8ke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fSByZXF1ZXN0cyByZW1haW5pbmcgdG9kYXksIHdpbGwgcmVzZXQgaW4gJHtyZXNldH0gaG91cnMuYClcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYCR7Y2hhbGsucmVkLmJvbGQoYEhUVFAgJHtyZXNwb25zZS5zdGF0dXNDb2RlfTpgKX0gJHtjaGFsay5yZWQoZXJyb3IpfWApXG4gICAgICB9XG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmVycm9yKGNoYWxrLnJlZChgUmVhY2hlZCB0b2RheSdzIHVzYWdlIGxpbWl0IG9mICR7Y29uZmlnLmRtdXNlLmRhdGUubGltaXR9LmApKVxuICAgIHByb2Nlc3MuZXhpdCgxKVxuICB9XG59XG4iXX0=