'use strict';

/* eslint max-len:0 */
var themes = require('../../themes');
var tools = require('../../tools');

var _ = require('lodash');
var chalk = require('chalk');
var moment = require('moment');
var http = require('good-guy-http')();
var noon = require('noon');

var CFILE = process.env.HOME + '/.leximaven.noon';

exports.command = 'get <condition>';
exports.desc = 'Datamuse query';
exports.builder = {
  out: {
    alias: 'o',
    desc: 'Write cson, json, noon, plist, yaml, xml',
    default: '',
    type: 'string'
  },
  force: {
    alias: 'f',
    desc: 'Force overwriting outfile',
    default: false,
    type: 'boolean'
  },
  save: {
    alias: 's',
    desc: 'Save flags to config file',
    default: false,
    type: 'boolean'
  },
  max: {
    alias: 'm',
    desc: 'Maximum number of results, 1 to 1000',
    default: 5,
    type: 'number'
  }
};
exports.handler = function (argv) {
  tools.checkConfig(CFILE);
  var config = noon.load(CFILE);
  var proceed = false;
  var stamp = new Date(config.dmuse.date.stamp);
  var hours = moment(new Date()).diff(stamp, 'hours');
  var minutes = moment(new Date()).diff(stamp, 'minutes');
  var reset = false;
  if (hours < 24) {
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  } else if (hours >= 24) {
    reset = true;
    config.dmuse.date.stamp = moment().format();
    config.dmuse.date.remain = config.dmuse.date.limit;
    console.log(chalk.white('Reset API limit to ' + config.dmuse.date.limit + '/' + config.dmuse.date.interval + '.'));
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  }
  if (config.dmuse.date.remain === 0) {
    proceed = false;
  } else if (config.dmuse.date.remain < 0) {
    proceed = false;
    config.dmuse.date.remain = 0;
    noon.save(CFILE, config);
  } else {
    proceed = true;
  }
  if (proceed) {
    (function () {
      var userConfig = {
        dmuse: {
          max: argv.m
        }
      };
      if (config.merge) config = _.merge({}, config, userConfig);
      var theme = themes.loadTheme(config.theme);
      if (config.verbose) themes.labelDown('Datamuse', theme, null);
      var ccont = [];
      ccont.push(argv.condition);
      if (argv._.length > 1) {
        _.each(argv._, function (value) {
          ccont.push(value);
        });
      }
      var prefix = 'http://api.datamuse.com/words?';
      var conditions = 'max=' + config.dmuse.max + '&';
      _.each(ccont, function (value) {
        conditions = conditions + '&' + value;
      });
      var url = '' + prefix + conditions;
      url = encodeURI(url);
      var tags = {
        n: 'noun',
        adj: 'adjective',
        adv: 'adverb',
        syn: 'synonym'
      };
      var tofile = {
        type: 'datamuse',
        source: 'http://datamuse.com/api',
        url: url
      };
      var ctstyle = _.get(chalk, theme.content.style);
      http({ url: url }, function (error, response) {
        if (!error && response.statusCode === 200) {
          var resp = JSON.parse(response.body);
          for (var i = 0; i <= resp.length - 1; i++) {
            var item = resp[i];
            themes.labelRight('Match', theme, item.word + ' ');
            tofile[['match' + i]] = item.word;
            if (item.tags !== undefined && item.tags !== []) {
              themes.labelRight('Tags', theme, null);
              for (var j = 0; j <= item.tags.length - 1; j++) {
                if (j === item.tags.length - 1) {
                  process.stdout.write(ctstyle('' + tags[item.tags[j]]));
                  tofile[['tags' + j]] = tags[item.tags[j]];
                } else {
                  process.stdout.write(ctstyle(tags[item.tags[j]] + ', '));
                }
              }
              console.log('');
            }
          }
          if (argv.o) tools.outFile(argv.o, argv.f, tofile);
          if (argv.s && config.merge) noon.save(CFILE, config);
          if (argv.s && !config.merge) throw new Error("Can't save user config, set option merge to true.");
          if (reset) {
            console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today.');
          } else {
            if (config.usage) console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today, will reset in ' + (23 - hours) + ' hours, ' + (59 - minutes) + ' minutes.');
          }
        } else {
          throw new Error('HTTP ' + response.statusCode + ': ' + error);
        }
      });
    })();
  } else {
    throw new Error('Reached today\'s usage limit of ' + config.dmuse.date.limit + '.');
  }
};
//# sourceMappingURL=data:application/json;base64,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dGVudCI6WyIvKiBlc2xpbnQgbWF4LWxlbjowICovXG5jb25zdCB0aGVtZXMgPSByZXF1aXJlKCcuLi8uLi90aGVtZXMnKVxuY29uc3QgdG9vbHMgPSByZXF1aXJlKCcuLi8uLi90b29scycpXG5cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxuY29uc3QgaHR0cCA9IHJlcXVpcmUoJ2dvb2QtZ3V5LWh0dHAnKSgpXG5jb25zdCBub29uID0gcmVxdWlyZSgnbm9vbicpXG5cbmNvbnN0IENGSUxFID0gYCR7cHJvY2Vzcy5lbnYuSE9NRX0vLmxleGltYXZlbi5ub29uYFxuXG5leHBvcnRzLmNvbW1hbmQgPSAnZ2V0IDxjb25kaXRpb24+J1xuZXhwb3J0cy5kZXNjID0gJ0RhdGFtdXNlIHF1ZXJ5J1xuZXhwb3J0cy5idWlsZGVyID0ge1xuICBvdXQ6IHtcbiAgICBhbGlhczogJ28nLFxuICAgIGRlc2M6ICdXcml0ZSBjc29uLCBqc29uLCBub29uLCBwbGlzdCwgeWFtbCwgeG1sJyxcbiAgICBkZWZhdWx0OiAnJyxcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgfSxcbiAgZm9yY2U6IHtcbiAgICBhbGlhczogJ2YnLFxuICAgIGRlc2M6ICdGb3JjZSBvdmVyd3JpdGluZyBvdXRmaWxlJyxcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gIH0sXG4gIHNhdmU6IHtcbiAgICBhbGlhczogJ3MnLFxuICAgIGRlc2M6ICdTYXZlIGZsYWdzIHRvIGNvbmZpZyBmaWxlJyxcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gIH0sXG4gIG1heDoge1xuICAgIGFsaWFzOiAnbScsXG4gICAgZGVzYzogJ01heGltdW0gbnVtYmVyIG9mIHJlc3VsdHMsIDEgdG8gMTAwMCcsXG4gICAgZGVmYXVsdDogNSxcbiAgICB0eXBlOiAnbnVtYmVyJyxcbiAgfSxcbn1cbmV4cG9ydHMuaGFuZGxlciA9IChhcmd2KSA9PiB7XG4gIHRvb2xzLmNoZWNrQ29uZmlnKENGSUxFKVxuICBsZXQgY29uZmlnID0gbm9vbi5sb2FkKENGSUxFKVxuICBsZXQgcHJvY2VlZCA9IGZhbHNlXG4gIGNvbnN0IHN0YW1wID0gbmV3IERhdGUoY29uZmlnLmRtdXNlLmRhdGUuc3RhbXApXG4gIGNvbnN0IGhvdXJzID0gbW9tZW50KG5ldyBEYXRlKS5kaWZmKHN0YW1wLCAnaG91cnMnKVxuICBjb25zdCBtaW51dGVzID0gbW9tZW50KG5ldyBEYXRlKS5kaWZmKHN0YW1wLCAnbWludXRlcycpXG4gIGxldCByZXNldCA9IGZhbHNlXG4gIGlmIChob3VycyA8IDI0KSB7XG4gICAgY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID0gY29uZmlnLmRtdXNlLmRhdGUucmVtYWluIC0gMVxuICAgIG5vb24uc2F2ZShDRklMRSwgY29uZmlnKVxuICB9IGVsc2UgaWYgKGhvdXJzID49IDI0KSB7XG4gICAgcmVzZXQgPSB0cnVlXG4gICAgY29uZmlnLmRtdXNlLmRhdGUuc3RhbXAgPSBtb21lbnQoKS5mb3JtYXQoKVxuICAgIGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9IGNvbmZpZy5kbXVzZS5kYXRlLmxpbWl0XG4gICAgY29uc29sZS5sb2coY2hhbGsud2hpdGUoYFJlc2V0IEFQSSBsaW1pdCB0byAke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fS8ke2NvbmZpZy5kbXVzZS5kYXRlLmludGVydmFsfS5gKSlcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH1cbiAgaWYgKGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9PT0gMCkge1xuICAgIHByb2NlZWQgPSBmYWxzZVxuICB9IGVsc2UgaWYgKGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA8IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSAwXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH0gZWxzZSB7XG4gICAgcHJvY2VlZCA9IHRydWVcbiAgfVxuICBpZiAocHJvY2VlZCkge1xuICAgIGNvbnN0IHVzZXJDb25maWcgPSB7XG4gICAgICBkbXVzZToge1xuICAgICAgICBtYXg6IGFyZ3YubSxcbiAgICAgIH0sXG4gICAgfVxuICAgIGlmIChjb25maWcubWVyZ2UpIGNvbmZpZyA9IF8ubWVyZ2Uoe30sIGNvbmZpZywgdXNlckNvbmZpZylcbiAgICBjb25zdCB0aGVtZSA9IHRoZW1lcy5sb2FkVGhlbWUoY29uZmlnLnRoZW1lKVxuICAgIGlmIChjb25maWcudmVyYm9zZSkgdGhlbWVzLmxhYmVsRG93bignRGF0YW11c2UnLCB0aGVtZSwgbnVsbClcbiAgICBjb25zdCBjY29udCA9IFtdXG4gICAgY2NvbnQucHVzaChhcmd2LmNvbmRpdGlvbilcbiAgICBpZiAoYXJndi5fLmxlbmd0aCA+IDEpIHtcbiAgICAgIF8uZWFjaChhcmd2Ll8sICh2YWx1ZSkgPT4ge1xuICAgICAgICBjY29udC5wdXNoKHZhbHVlKVxuICAgICAgfSlcbiAgICB9XG4gICAgY29uc3QgcHJlZml4ID0gJ2h0dHA6Ly9hcGkuZGF0YW11c2UuY29tL3dvcmRzPydcbiAgICBsZXQgY29uZGl0aW9ucyA9IGBtYXg9JHtjb25maWcuZG11c2UubWF4fSZgXG4gICAgXy5lYWNoKGNjb250LCAodmFsdWUpID0+IHtcbiAgICAgIGNvbmRpdGlvbnMgPSBgJHtjb25kaXRpb25zfSYke3ZhbHVlfWBcbiAgICB9KVxuICAgIGxldCB1cmwgPSBgJHtwcmVmaXh9JHtjb25kaXRpb25zfWBcbiAgICB1cmwgPSBlbmNvZGVVUkkodXJsKVxuICAgIGNvbnN0IHRhZ3MgPSB7XG4gICAgICBuOiAnbm91bicsXG4gICAgICBhZGo6ICdhZGplY3RpdmUnLFxuICAgICAgYWR2OiAnYWR2ZXJiJyxcbiAgICAgIHN5bjogJ3N5bm9ueW0nLFxuICAgIH1cbiAgICBjb25zdCB0b2ZpbGUgPSB7XG4gICAgICB0eXBlOiAnZGF0YW11c2UnLFxuICAgICAgc291cmNlOiAnaHR0cDovL2RhdGFtdXNlLmNvbS9hcGknLFxuICAgICAgdXJsLFxuICAgIH1cbiAgICBjb25zdCBjdHN0eWxlID0gXy5nZXQoY2hhbGssIHRoZW1lLmNvbnRlbnQuc3R5bGUpXG4gICAgaHR0cCh7IHVybCB9LCAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgICBpZiAoIWVycm9yICYmIHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICBjb25zdCByZXNwID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KVxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSByZXNwLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICAgIGNvbnN0IGl0ZW0gPSByZXNwW2ldXG4gICAgICAgICAgdGhlbWVzLmxhYmVsUmlnaHQoJ01hdGNoJywgdGhlbWUsIGAke2l0ZW0ud29yZH0gYClcbiAgICAgICAgICB0b2ZpbGVbW2BtYXRjaCR7aX1gXV0gPSBpdGVtLndvcmRcbiAgICAgICAgICBpZiAoaXRlbS50YWdzICE9PSB1bmRlZmluZWQgJiYgaXRlbS50YWdzICE9PSBbXSkge1xuICAgICAgICAgICAgdGhlbWVzLmxhYmVsUmlnaHQoJ1RhZ3MnLCB0aGVtZSwgbnVsbClcbiAgICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IGl0ZW0udGFncy5sZW5ndGggLSAxOyBqKyspIHtcbiAgICAgICAgICAgICAgaWYgKGogPT09IGl0ZW0udGFncy5sZW5ndGggLSAxKSB7XG4gICAgICAgICAgICAgICAgcHJvY2Vzcy5zdGRvdXQud3JpdGUoY3RzdHlsZShgJHt0YWdzW2l0ZW0udGFnc1tqXV19YCkpXG4gICAgICAgICAgICAgICAgdG9maWxlW1tgdGFncyR7an1gXV0gPSB0YWdzW2l0ZW0udGFnc1tqXV1cbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjdHN0eWxlKGAke3RhZ3NbaXRlbS50YWdzW2pdXX0sIGApKVxuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnJylcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGFyZ3YubykgdG9vbHMub3V0RmlsZShhcmd2Lm8sIGFyZ3YuZiwgdG9maWxlKVxuICAgICAgICBpZiAoYXJndi5zICYmIGNvbmZpZy5tZXJnZSkgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gICAgICAgIGlmIChhcmd2LnMgJiYgIWNvbmZpZy5tZXJnZSkgdGhyb3cgbmV3IEVycm9yKFwiQ2FuJ3Qgc2F2ZSB1c2VyIGNvbmZpZywgc2V0IG9wdGlvbiBtZXJnZSB0byB0cnVlLlwiKVxuICAgICAgICBpZiAocmVzZXQpIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgJHtjb25maWcuZG11c2UuZGF0ZS5yZW1haW59LyR7Y29uZmlnLmRtdXNlLmRhdGUubGltaXR9IHJlcXVlc3RzIHJlbWFpbmluZyB0b2RheS5gKVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGlmIChjb25maWcudXNhZ2UpIGNvbnNvbGUubG9nKGAke2NvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbn0vJHtjb25maWcuZG11c2UuZGF0ZS5saW1pdH0gcmVxdWVzdHMgcmVtYWluaW5nIHRvZGF5LCB3aWxsIHJlc2V0IGluICR7MjMgLSBob3Vyc30gaG91cnMsICR7NTkgLSBtaW51dGVzfSBtaW51dGVzLmApXG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c0NvZGV9OiAke2Vycm9yfWApXG4gICAgICB9XG4gICAgfSlcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFJlYWNoZWQgdG9kYXkncyB1c2FnZSBsaW1pdCBvZiAke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fS5gKVxuICB9XG59XG4iXX0=