'use strict';

/* eslint max-len:0 */
var themes = require('../../themes');
var tools = require('../../tools');

var _ = require('lodash');
var chalk = require('chalk');
var moment = require('moment');
var needle = require('needle');
var noon = require('noon');

var CFILE = process.env.HOME + '/.leximaven.noon';

exports.command = 'get <condition>';
exports.desc = 'Datamuse query';
exports.builder = {
  out: {
    alias: 'o',
    desc: 'Write cson, json, noon, plist, yaml, xml',
    default: '',
    type: 'string'
  },
  force: {
    alias: 'f',
    desc: 'Force overwriting outfile',
    default: false,
    type: 'boolean'
  },
  save: {
    alias: 's',
    desc: 'Save flags to config file',
    default: false,
    type: 'boolean'
  },
  max: {
    alias: 'm',
    desc: 'Maximum number of results, 1 to 1000',
    default: 5,
    type: 'number'
  }
};
exports.handler = function (argv) {
  tools.checkConfig(CFILE);
  var config = noon.load(CFILE);
  var proceed = false;
  var stamp = new Date(config.dmuse.date.stamp);
  var hours = moment(new Date()).diff(stamp, 'hours');
  var minutes = moment(new Date()).diff(stamp, 'minutes');
  var reset = false;
  if (hours < 24) {
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  } else if (hours >= 24) {
    reset = true;
    config.dmuse.date.stamp = moment().format();
    config.dmuse.date.remain = config.dmuse.date.limit;
    console.log(chalk.white('Reset API limit to ' + config.dmuse.date.limit + '/' + config.dmuse.date.interval + '.'));
    config.dmuse.date.remain = config.dmuse.date.remain - 1;
    noon.save(CFILE, config);
  }
  if (config.dmuse.date.remain === 0) {
    proceed = false;
  } else if (config.dmuse.date.remain < 0) {
    proceed = false;
    config.dmuse.date.remain = 0;
    noon.save(CFILE, config);
  } else {
    proceed = true;
  }
  if (proceed) {
    (function () {
      var userConfig = {
        dmuse: {
          max: argv.m
        }
      };
      if (config.merge) config = _.merge({}, config, userConfig);
      var theme = themes.loadTheme(config.theme);
      if (config.verbose) themes.labelDown('Datamuse', theme, null);
      var ccont = [];
      ccont.push(argv.condition);
      if (argv._.length > 1) {
        _.each(argv._, function (value) {
          ccont.push(value);
        });
      }
      var prefix = 'http://api.datamuse.com/words?';
      var conditions = 'max=' + config.dmuse.max + '&';
      _.each(ccont, function (value) {
        conditions = conditions + '&' + value;
      });
      var url = '' + prefix + conditions;
      url = encodeURI(url);
      var tags = {
        n: 'noun',
        adj: 'adjective',
        adv: 'adverb',
        syn: 'synonym'
      };
      var tofile = {
        type: 'datamuse',
        source: 'http://datamuse.com/api',
        url: url
      };
      var ctstyle = _.get(chalk, theme.content.style);
      needle.get(url, function (error, response) {
        if (!error && response.statusCode === 200) {
          var resp = response.body;
          for (var i = 0; i <= resp.length - 1; i++) {
            var item = resp[i];
            themes.labelRight('Match', theme, item.word + ' ');
            tofile[['match' + i]] = item.word;
            if (item.tags !== undefined && item.tags !== []) {
              themes.labelRight('Tags', theme, null);
              for (var j = 0; j <= item.tags.length - 1; j++) {
                if (j === item.tags.length - 1) {
                  process.stdout.write(ctstyle('' + tags[item.tags[j]]));
                  tofile[['tags' + j]] = tags[item.tags[j]];
                } else {
                  process.stdout.write(ctstyle(tags[item.tags[j]] + ', '));
                }
              }
              console.log('');
            }
          }
          if (argv.o) tools.outFile(argv.o, argv.f, tofile);
          if (argv.s && config.merge) noon.save(CFILE, config);
          if (argv.s && !config.merge) console.err(chalk.red('Set option merge to true!'));
          if (reset) {
            console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today.');
          } else {
            console.log(config.dmuse.date.remain + '/' + config.dmuse.date.limit + ' requests remaining today, will reset in ' + (23 - hours) + ' hours, ' + (59 - minutes) + ' minutes.');
          }
        } else {
          console.error(chalk.red.bold('HTTP ' + response.statusCode + ':') + ' ' + chalk.red(error));
        }
      });
    })();
  } else {
    console.error(chalk.red('Reached today\'s usage limit of ' + config.dmuse.date.limit + '.'));
    process.exit(1);
  }
};
//# sourceMappingURL=data:application/json;base64,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RCIsImZpbGUiOiJjbWRzL2RtdXNlX2NtZHMvZ2V0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IG1heC1sZW46MCAqL1xuY29uc3QgdGhlbWVzID0gcmVxdWlyZSgnLi4vLi4vdGhlbWVzJylcbmNvbnN0IHRvb2xzID0gcmVxdWlyZSgnLi4vLi4vdG9vbHMnKVxuXG5jb25zdCBfID0gcmVxdWlyZSgnbG9kYXNoJylcbmNvbnN0IGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKVxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50JylcbmNvbnN0IG5lZWRsZSA9IHJlcXVpcmUoJ25lZWRsZScpXG5jb25zdCBub29uID0gcmVxdWlyZSgnbm9vbicpXG5cbmNvbnN0IENGSUxFID0gYCR7cHJvY2Vzcy5lbnYuSE9NRX0vLmxleGltYXZlbi5ub29uYFxuXG5leHBvcnRzLmNvbW1hbmQgPSAnZ2V0IDxjb25kaXRpb24+J1xuZXhwb3J0cy5kZXNjID0gJ0RhdGFtdXNlIHF1ZXJ5J1xuZXhwb3J0cy5idWlsZGVyID0ge1xuICBvdXQ6IHtcbiAgICBhbGlhczogJ28nLFxuICAgIGRlc2M6ICdXcml0ZSBjc29uLCBqc29uLCBub29uLCBwbGlzdCwgeWFtbCwgeG1sJyxcbiAgICBkZWZhdWx0OiAnJyxcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgfSxcbiAgZm9yY2U6IHtcbiAgICBhbGlhczogJ2YnLFxuICAgIGRlc2M6ICdGb3JjZSBvdmVyd3JpdGluZyBvdXRmaWxlJyxcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gIH0sXG4gIHNhdmU6IHtcbiAgICBhbGlhczogJ3MnLFxuICAgIGRlc2M6ICdTYXZlIGZsYWdzIHRvIGNvbmZpZyBmaWxlJyxcbiAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICB0eXBlOiAnYm9vbGVhbicsXG4gIH0sXG4gIG1heDoge1xuICAgIGFsaWFzOiAnbScsXG4gICAgZGVzYzogJ01heGltdW0gbnVtYmVyIG9mIHJlc3VsdHMsIDEgdG8gMTAwMCcsXG4gICAgZGVmYXVsdDogNSxcbiAgICB0eXBlOiAnbnVtYmVyJyxcbiAgfSxcbn1cbmV4cG9ydHMuaGFuZGxlciA9IChhcmd2KSA9PiB7XG4gIHRvb2xzLmNoZWNrQ29uZmlnKENGSUxFKVxuICBsZXQgY29uZmlnID0gbm9vbi5sb2FkKENGSUxFKVxuICBsZXQgcHJvY2VlZCA9IGZhbHNlXG4gIGNvbnN0IHN0YW1wID0gbmV3IERhdGUoY29uZmlnLmRtdXNlLmRhdGUuc3RhbXApXG4gIGNvbnN0IGhvdXJzID0gbW9tZW50KG5ldyBEYXRlKS5kaWZmKHN0YW1wLCAnaG91cnMnKVxuICBjb25zdCBtaW51dGVzID0gbW9tZW50KG5ldyBEYXRlKS5kaWZmKHN0YW1wLCAnbWludXRlcycpXG4gIGxldCByZXNldCA9IGZhbHNlXG4gIGlmIChob3VycyA8IDI0KSB7XG4gICAgY29uZmlnLmRtdXNlLmRhdGUucmVtYWluID0gY29uZmlnLmRtdXNlLmRhdGUucmVtYWluIC0gMVxuICAgIG5vb24uc2F2ZShDRklMRSwgY29uZmlnKVxuICB9IGVsc2UgaWYgKGhvdXJzID49IDI0KSB7XG4gICAgcmVzZXQgPSB0cnVlXG4gICAgY29uZmlnLmRtdXNlLmRhdGUuc3RhbXAgPSBtb21lbnQoKS5mb3JtYXQoKVxuICAgIGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9IGNvbmZpZy5kbXVzZS5kYXRlLmxpbWl0XG4gICAgY29uc29sZS5sb2coY2hhbGsud2hpdGUoYFJlc2V0IEFQSSBsaW1pdCB0byAke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fS8ke2NvbmZpZy5kbXVzZS5kYXRlLmludGVydmFsfS5gKSlcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH1cbiAgaWYgKGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA9PT0gMCkge1xuICAgIHByb2NlZWQgPSBmYWxzZVxuICB9IGVsc2UgaWYgKGNvbmZpZy5kbXVzZS5kYXRlLnJlbWFpbiA8IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgICBjb25maWcuZG11c2UuZGF0ZS5yZW1haW4gPSAwXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gIH0gZWxzZSB7XG4gICAgcHJvY2VlZCA9IHRydWVcbiAgfVxuICBpZiAocHJvY2VlZCkge1xuICAgIGNvbnN0IHVzZXJDb25maWcgPSB7XG4gICAgICBkbXVzZToge1xuICAgICAgICBtYXg6IGFyZ3YubSxcbiAgICAgIH0sXG4gICAgfVxuICAgIGlmIChjb25maWcubWVyZ2UpIGNvbmZpZyA9IF8ubWVyZ2Uoe30sIGNvbmZpZywgdXNlckNvbmZpZylcbiAgICBjb25zdCB0aGVtZSA9IHRoZW1lcy5sb2FkVGhlbWUoY29uZmlnLnRoZW1lKVxuICAgIGlmIChjb25maWcudmVyYm9zZSkgdGhlbWVzLmxhYmVsRG93bignRGF0YW11c2UnLCB0aGVtZSwgbnVsbClcbiAgICBjb25zdCBjY29udCA9IFtdXG4gICAgY2NvbnQucHVzaChhcmd2LmNvbmRpdGlvbilcbiAgICBpZiAoYXJndi5fLmxlbmd0aCA+IDEpIHtcbiAgICAgIF8uZWFjaChhcmd2Ll8sICh2YWx1ZSkgPT4ge1xuICAgICAgICBjY29udC5wdXNoKHZhbHVlKVxuICAgICAgfSlcbiAgICB9XG4gICAgY29uc3QgcHJlZml4ID0gJ2h0dHA6Ly9hcGkuZGF0YW11c2UuY29tL3dvcmRzPydcbiAgICBsZXQgY29uZGl0aW9ucyA9IGBtYXg9JHtjb25maWcuZG11c2UubWF4fSZgXG4gICAgXy5lYWNoKGNjb250LCAodmFsdWUpID0+IHtcbiAgICAgIGNvbmRpdGlvbnMgPSBgJHtjb25kaXRpb25zfSYke3ZhbHVlfWBcbiAgICB9KVxuICAgIGxldCB1cmwgPSBgJHtwcmVmaXh9JHtjb25kaXRpb25zfWBcbiAgICB1cmwgPSBlbmNvZGVVUkkodXJsKVxuICAgIGNvbnN0IHRhZ3MgPSB7XG4gICAgICBuOiAnbm91bicsXG4gICAgICBhZGo6ICdhZGplY3RpdmUnLFxuICAgICAgYWR2OiAnYWR2ZXJiJyxcbiAgICAgIHN5bjogJ3N5bm9ueW0nLFxuICAgIH1cbiAgICBjb25zdCB0b2ZpbGUgPSB7XG4gICAgICB0eXBlOiAnZGF0YW11c2UnLFxuICAgICAgc291cmNlOiAnaHR0cDovL2RhdGFtdXNlLmNvbS9hcGknLFxuICAgICAgdXJsLFxuICAgIH1cbiAgICBjb25zdCBjdHN0eWxlID0gXy5nZXQoY2hhbGssIHRoZW1lLmNvbnRlbnQuc3R5bGUpXG4gICAgbmVlZGxlLmdldCh1cmwsIChlcnJvciwgcmVzcG9uc2UpID0+IHtcbiAgICAgIGlmICghZXJyb3IgJiYgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgIGNvbnN0IHJlc3AgPSByZXNwb25zZS5ib2R5XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IHJlc3AubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHJlc3BbaV1cbiAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnTWF0Y2gnLCB0aGVtZSwgYCR7aXRlbS53b3JkfSBgKVxuICAgICAgICAgIHRvZmlsZVtbYG1hdGNoJHtpfWBdXSA9IGl0ZW0ud29yZFxuICAgICAgICAgIGlmIChpdGVtLnRhZ3MgIT09IHVuZGVmaW5lZCAmJiBpdGVtLnRhZ3MgIT09IFtdKSB7XG4gICAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnVGFncycsIHRoZW1lLCBudWxsKVxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPD0gaXRlbS50YWdzLmxlbmd0aCAtIDE7IGorKykge1xuICAgICAgICAgICAgICBpZiAoaiA9PT0gaXRlbS50YWdzLmxlbmd0aCAtIDEpIHtcbiAgICAgICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjdHN0eWxlKGAke3RhZ3NbaXRlbS50YWdzW2pdXX1gKSlcbiAgICAgICAgICAgICAgICB0b2ZpbGVbW2B0YWdzJHtqfWBdXSA9IHRhZ3NbaXRlbS50YWdzW2pdXVxuICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGN0c3R5bGUoYCR7dGFnc1tpdGVtLnRhZ3Nbal1dfSwgYCkpXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCcnKVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoYXJndi5vKSB0b29scy5vdXRGaWxlKGFyZ3YubywgYXJndi5mLCB0b2ZpbGUpXG4gICAgICAgIGlmIChhcmd2LnMgJiYgY29uZmlnLm1lcmdlKSBub29uLnNhdmUoQ0ZJTEUsIGNvbmZpZylcbiAgICAgICAgaWYgKGFyZ3YucyAmJiAhY29uZmlnLm1lcmdlKSBjb25zb2xlLmVycihjaGFsay5yZWQoJ1NldCBvcHRpb24gbWVyZ2UgdG8gdHJ1ZSEnKSlcbiAgICAgICAgaWYgKHJlc2V0KSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYCR7Y29uZmlnLmRtdXNlLmRhdGUucmVtYWlufS8ke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fSByZXF1ZXN0cyByZW1haW5pbmcgdG9kYXkuYClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhgJHtjb25maWcuZG11c2UuZGF0ZS5yZW1haW59LyR7Y29uZmlnLmRtdXNlLmRhdGUubGltaXR9IHJlcXVlc3RzIHJlbWFpbmluZyB0b2RheSwgd2lsbCByZXNldCBpbiAkezIzIC0gaG91cnN9IGhvdXJzLCAkezU5IC0gbWludXRlc30gbWludXRlcy5gKVxuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGAke2NoYWxrLnJlZC5ib2xkKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX06YCl9ICR7Y2hhbGsucmVkKGVycm9yKX1gKVxuICAgICAgfVxuICAgIH0pXG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5lcnJvcihjaGFsay5yZWQoYFJlYWNoZWQgdG9kYXkncyB1c2FnZSBsaW1pdCBvZiAke2NvbmZpZy5kbXVzZS5kYXRlLmxpbWl0fS5gKSlcbiAgICBwcm9jZXNzLmV4aXQoMSlcbiAgfVxufVxuIl19