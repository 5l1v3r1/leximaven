'use strict';

var themes = require('../../themes');
var tools = require('../../tools');

var _ = require('lodash');
var chalk = require('chalk');
var needle = require('needle');
var noon = require('noon');

var CFILE = process.env.HOME + '/.leximaven.noon';

exports.command = 'get <condition>';
exports.desc = 'Datamuse query';
exports.builder = {
  out: {
    alias: 'o',
    desc: 'Write cson, json, noon, plist, yaml, xml',
    default: '',
    type: 'string'
  },
  force: {
    alias: 'f',
    desc: 'Force overwriting outfile',
    default: false,
    type: 'boolean'
  },
  save: {
    alias: 's',
    desc: 'Save flags to config file',
    default: false,
    type: 'boolean'
  },
  max: {
    alias: 'm',
    desc: 'Maximum number of results, 1 to 1000',
    default: 5,
    type: 'number'
  }
};
exports.handler = function (argv) {
  tools.checkConfig(CFILE);
  var config = noon.load(CFILE);
  var userConfig = {
    dmuse: {
      max: argv.m
    }
  };
  if (config.merge) config = _.merge({}, config, userConfig);
  var theme = themes.loadTheme(config.theme);
  if (config.verbose) themes.labelDown('Datamuse', theme, null);
  var ccont = [];
  ccont.push(argv.condition);
  if (argv._.length > 1) {
    for (var i = 1; i <= argv._.length - 1; i++) {
      ccont.push(argv._[i]);
    }
  }
  var prefix = 'http://api.datamuse.com/words?';
  var conditions = 'max=' + config.dmuse.max + '&';
  _.each(ccont, function (value) {
    conditions = conditions + '&' + value;
  });
  var url = '' + prefix + conditions;
  url = encodeURI(url);
  var tags = {
    n: 'noun',
    adj: 'adjective',
    adv: 'adverb',
    syn: 'synonym'
  };
  var tofile = { type: 'datamuse', source: 'http://datamuse.com/api' };
  var ctstyle = _.get(chalk, theme.content.style);
  needle.get(url, function (error, response) {
    if (!error && response.statusCode === 200) {
      var resp = response.body;
      for (var _i = 0; _i <= resp.length - 1; _i++) {
        var item = resp[_i];
        themes.labelRight('Match', theme, item.word + ' ');
        tofile[['match' + _i]] = item.word;
        if (item.tags !== undefined && item.tags !== []) {
          themes.labelRight('Tags', theme, null);
          for (var j = 0; j <= item.tags.length - 1; j++) {
            if (j === item.tags.length - 1) {
              process.stdout.write(ctstyle('' + tags[item.tags[j]]));
              tofile[['tags' + j]] = tags[item.tags[j]];
            } else {
              process.stdout.write(ctstyle(tags[item.tags[j]] + ', '));
            }
          }
          console.log('');
        }
      }
      if (argv.o) tools.outFile(argv.o, argv.f, tofile);
      if (argv.s && config.merge) noon.save(CFILE, config);
      if (argv.s && !config.merge) console.err(chalk.red('Set option merge to true!'));
    } else {
      console.error(chalk.red.bold('HTTP ' + response.statusCode + ':') + ' ' + chalk.red(error));
    }
  });
};
//# sourceMappingURL=data:application/json;base64,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QixFQUE0QixLQUFLLElBQUwsQ0FBVSxLQUFWLEVBQWlCLE1BQWpCO0FBQzVCLFVBQUksS0FBSyxDQUFMLElBQVUsQ0FBQyxPQUFPLEtBQXRCLEVBQTZCLFFBQVEsR0FBUixDQUFZLE1BQU0sR0FBTixDQUFVLDJCQUFWLENBQVo7QUFDOUIsS0F0QkQsTUFzQk87QUFDTCxjQUFRLEtBQVIsQ0FBaUIsTUFBTSxHQUFOLENBQVUsSUFBVixXQUF1QixTQUFTLFVBQWhDLE9BQWpCLFNBQW1FLE1BQU0sR0FBTixDQUFVLEtBQVYsQ0FBbkU7QUFDRDtBQUNGLEdBMUJEO0FBMkJELENBNUREIiwiZmlsZSI6ImNtZHMvZG11c2VfY21kcy9nZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCB0aGVtZXMgPSByZXF1aXJlKCcuLi8uLi90aGVtZXMnKVxuY29uc3QgdG9vbHMgPSByZXF1aXJlKCcuLi8uLi90b29scycpXG5cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKVxuY29uc3QgY2hhbGsgPSByZXF1aXJlKCdjaGFsaycpXG5jb25zdCBuZWVkbGUgPSByZXF1aXJlKCduZWVkbGUnKVxuY29uc3Qgbm9vbiA9IHJlcXVpcmUoJ25vb24nKVxuXG5jb25zdCBDRklMRSA9IGAke3Byb2Nlc3MuZW52LkhPTUV9Ly5sZXhpbWF2ZW4ubm9vbmBcblxuZXhwb3J0cy5jb21tYW5kID0gJ2dldCA8Y29uZGl0aW9uPidcbmV4cG9ydHMuZGVzYyA9ICdEYXRhbXVzZSBxdWVyeSdcbmV4cG9ydHMuYnVpbGRlciA9IHtcbiAgb3V0OiB7XG4gICAgYWxpYXM6ICdvJyxcbiAgICBkZXNjOiAnV3JpdGUgY3NvbiwganNvbiwgbm9vbiwgcGxpc3QsIHlhbWwsIHhtbCcsXG4gICAgZGVmYXVsdDogJycsXG4gICAgdHlwZTogJ3N0cmluZycsXG4gIH0sXG4gIGZvcmNlOiB7XG4gICAgYWxpYXM6ICdmJyxcbiAgICBkZXNjOiAnRm9yY2Ugb3ZlcndyaXRpbmcgb3V0ZmlsZScsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxuICB9LFxuICBzYXZlOiB7XG4gICAgYWxpYXM6ICdzJyxcbiAgICBkZXNjOiAnU2F2ZSBmbGFncyB0byBjb25maWcgZmlsZScsXG4gICAgZGVmYXVsdDogZmFsc2UsXG4gICAgdHlwZTogJ2Jvb2xlYW4nLFxuICB9LFxuICBtYXg6IHtcbiAgICBhbGlhczogJ20nLFxuICAgIGRlc2M6ICdNYXhpbXVtIG51bWJlciBvZiByZXN1bHRzLCAxIHRvIDEwMDAnLFxuICAgIGRlZmF1bHQ6IDUsXG4gICAgdHlwZTogJ251bWJlcicsXG4gIH0sXG59XG5leHBvcnRzLmhhbmRsZXIgPSAoYXJndikgPT4ge1xuICB0b29scy5jaGVja0NvbmZpZyhDRklMRSlcbiAgbGV0IGNvbmZpZyA9IG5vb24ubG9hZChDRklMRSlcbiAgY29uc3QgdXNlckNvbmZpZyA9IHtcbiAgICBkbXVzZToge1xuICAgICAgbWF4OiBhcmd2Lm0sXG4gICAgfSxcbiAgfVxuICBpZiAoY29uZmlnLm1lcmdlKSBjb25maWcgPSBfLm1lcmdlKHt9LCBjb25maWcsIHVzZXJDb25maWcpXG4gIGNvbnN0IHRoZW1lID0gdGhlbWVzLmxvYWRUaGVtZShjb25maWcudGhlbWUpXG4gIGlmIChjb25maWcudmVyYm9zZSkgdGhlbWVzLmxhYmVsRG93bignRGF0YW11c2UnLCB0aGVtZSwgbnVsbClcbiAgY29uc3QgY2NvbnQgPSBbXVxuICBjY29udC5wdXNoKGFyZ3YuY29uZGl0aW9uKVxuICBpZiAoYXJndi5fLmxlbmd0aCA+IDEpIHtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhcmd2Ll8ubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICBjY29udC5wdXNoKGFyZ3YuX1tpXSlcbiAgICB9XG4gIH1cbiAgY29uc3QgcHJlZml4ID0gJ2h0dHA6Ly9hcGkuZGF0YW11c2UuY29tL3dvcmRzPydcbiAgbGV0IGNvbmRpdGlvbnMgPSBgbWF4PSR7Y29uZmlnLmRtdXNlLm1heH0mYFxuICBfLmVhY2goY2NvbnQsICh2YWx1ZSkgPT4ge1xuICAgIGNvbmRpdGlvbnMgPSBgJHtjb25kaXRpb25zfSYke3ZhbHVlfWBcbiAgfSlcbiAgbGV0IHVybCA9IGAke3ByZWZpeH0ke2NvbmRpdGlvbnN9YFxuICB1cmwgPSBlbmNvZGVVUkkodXJsKVxuICBjb25zdCB0YWdzID0ge1xuICAgIG46ICdub3VuJyxcbiAgICBhZGo6ICdhZGplY3RpdmUnLFxuICAgIGFkdjogJ2FkdmVyYicsXG4gICAgc3luOiAnc3lub255bScsXG4gIH1cbiAgY29uc3QgdG9maWxlID0geyB0eXBlOiAnZGF0YW11c2UnLCBzb3VyY2U6ICdodHRwOi8vZGF0YW11c2UuY29tL2FwaScgfVxuICBjb25zdCBjdHN0eWxlID0gXy5nZXQoY2hhbGssIHRoZW1lLmNvbnRlbnQuc3R5bGUpXG4gIG5lZWRsZS5nZXQodXJsLCAoZXJyb3IsIHJlc3BvbnNlKSA9PiB7XG4gICAgaWYgKCFlcnJvciAmJiByZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIGNvbnN0IHJlc3AgPSByZXNwb25zZS5ib2R5XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8PSByZXNwLmxlbmd0aCAtIDE7IGkrKykge1xuICAgICAgICBjb25zdCBpdGVtID0gcmVzcFtpXVxuICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnTWF0Y2gnLCB0aGVtZSwgYCR7aXRlbS53b3JkfSBgKVxuICAgICAgICB0b2ZpbGVbW2BtYXRjaCR7aX1gXV0gPSBpdGVtLndvcmRcbiAgICAgICAgaWYgKGl0ZW0udGFncyAhPT0gdW5kZWZpbmVkICYmIGl0ZW0udGFncyAhPT0gW10pIHtcbiAgICAgICAgICB0aGVtZXMubGFiZWxSaWdodCgnVGFncycsIHRoZW1lLCBudWxsKVxuICAgICAgICAgIGZvciAobGV0IGogPSAwOyBqIDw9IGl0ZW0udGFncy5sZW5ndGggLSAxOyBqKyspIHtcbiAgICAgICAgICAgIGlmIChqID09PSBpdGVtLnRhZ3MubGVuZ3RoIC0gMSkge1xuICAgICAgICAgICAgICBwcm9jZXNzLnN0ZG91dC53cml0ZShjdHN0eWxlKGAke3RhZ3NbaXRlbS50YWdzW2pdXX1gKSlcbiAgICAgICAgICAgICAgdG9maWxlW1tgdGFncyR7an1gXV0gPSB0YWdzW2l0ZW0udGFnc1tqXV1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0LndyaXRlKGN0c3R5bGUoYCR7dGFnc1tpdGVtLnRhZ3Nbal1dfSwgYCkpXG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuICAgICAgICAgIGNvbnNvbGUubG9nKCcnKVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBpZiAoYXJndi5vKSB0b29scy5vdXRGaWxlKGFyZ3YubywgYXJndi5mLCB0b2ZpbGUpXG4gICAgICBpZiAoYXJndi5zICYmIGNvbmZpZy5tZXJnZSkgbm9vbi5zYXZlKENGSUxFLCBjb25maWcpXG4gICAgICBpZiAoYXJndi5zICYmICFjb25maWcubWVyZ2UpIGNvbnNvbGUuZXJyKGNoYWxrLnJlZCgnU2V0IG9wdGlvbiBtZXJnZSB0byB0cnVlIScpKVxuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmVycm9yKGAke2NoYWxrLnJlZC5ib2xkKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX06YCl9ICR7Y2hhbGsucmVkKGVycm9yKX1gKVxuICAgIH1cbiAgfSlcbn1cbiJdfQ==