'use strict';

/* eslint max-len: 0 */
var chalk = require('chalk');
var fs = require('fs');
var moment = require('moment');
var noon = require('noon');
var xml2js = require('xml2js');

var CFILE = process.env.HOME + '/.leximaven.noon';

/**
  * The tools module provides useful repetitive tasks
  * @module Utils
  */

/**
  * Onelook's API limit check
  * @param  {Object} config The current config
  * @return {Array} Updated config, proceed boolean, and reset boolean
  */
exports.limitOnelook = function (config) {
  var c = config;
  var proceed = false;
  var reset = false;
  var stamp = new Date(c.onelook.date.stamp);
  var hours = moment(new Date()).diff(stamp, 'hours');
  if (hours < 24 || hours < 0) {
    c.onelook.date.remain = c.onelook.date.remain - 1;
    noon.save(CFILE, c);
  } else if (hours >= 24) {
    reset = true;
    c.onelook.date.stamp = moment().format();
    c.onelook.date.remain = c.onelook.date.limit;
    console.log(chalk.white('Reset API limit to ' + c.onelook.date.limit + '/' + c.onelook.date.interval + '.'));
    c.onelook.date.remain = c.onelook.date.remain - 1;
    noon.save(CFILE, c);
  }
  if (c.onelook.date.remain === 0) {
    proceed = false;
  } else if (c.onelook.date.remain < 0) {
    proceed = false;
    c.onelook.date.remain = 0;
    noon.save(CFILE, c);
  } else {
    proceed = true;
  }
  return [c, proceed, reset];
};

/**
  * Datamuse's API limit check
  * @param  {Object} config The current config
  * @return {Array} Updated config, proceed boolean, and reset boolean
  */
exports.limitDmuse = function (config) {
  var c = config;
  var proceed = false;
  var reset = false;
  var stamp = new Date(c.dmuse.date.stamp);
  var hours = moment(new Date()).diff(stamp, 'hours');
  if (hours < 24) {
    c.dmuse.date.remain = c.dmuse.date.remain - 1;
    noon.save(CFILE, c);
  } else if (hours >= 24) {
    reset = true;
    c.dmuse.date.stamp = moment().format();
    c.dmuse.date.remain = c.dmuse.date.limit;
    console.log(chalk.white('Reset API limit to ' + c.dmuse.date.limit + '/' + c.dmuse.date.interval + '.'));
    c.dmuse.date.remain = c.dmuse.date.remain - 1;
    noon.save(CFILE, c);
  }
  if (c.dmuse.date.remain === 0) {
    proceed = false;
  } else if (c.dmuse.date.remain < 0) {
    proceed = false;
    c.dmuse.date.remain = 0;
    noon.save(CFILE, c);
  } else {
    proceed = true;
  }
  return [c, proceed, reset];
};

/**
  * Rhymebrain's API limit check
  * @param  {Object} config The current config
  * @return {Array} Updated config, proceed boolean, and reset boolean
  */
exports.limitRbrain = function (config) {
  var c = config;
  var proceed = false;
  var reset = false;
  var stamp = new Date(c.rbrain.date.stamp);
  var minutes = moment(new Date()).diff(stamp, 'minutes');
  if (minutes < 60) {
    c.rbrain.date.remain = c.rbrain.date.remain - 1;
    noon.save(CFILE, c);
  } else if (minutes >= 60) {
    reset = true;
    c.rbrain.date.stamp = moment().format();
    c.rbrain.date.remain = c.rbrain.date.limit;
    console.log(chalk.white('Reset API limit to ' + c.rbrain.date.limit + '/' + c.rbrain.date.interval + '.'));
    c.rbrain.date.remain = c.rbrain.date.remain - 1;
    noon.save(CFILE, c);
  }
  if (c.rbrain.date.remain === 0) {
    proceed = false;
  } else if (c.rbrain.date.remain < 0) {
    proceed = false;
    c.rbrain.date.remain = 0;
    noon.save(CFILE, c);
  } else {
    proceed = true;
  }
  return [c, proceed, reset];
};

/**
  * Wordnik's API limit check
  * @param  {Object} config The current config
  * @return {Array} Updated config, proceed boolean, and reset boolean
  */
exports.limitWordnik = function (config) {
  var c = config;
  var proceed = false;
  var reset = false;
  var stamp = new Date(c.wordnik.date.stamp);
  var minutes = moment(new Date()).diff(stamp, 'minutes');
  if (minutes < 60) {
    c.wordnik.date.remain = c.wordnik.date.remain - 1;
    noon.save(CFILE, c);
  } else if (minutes >= 60) {
    reset = true;
    c.wordnik.date.stamp = moment().format();
    c.wordnik.date.remain = c.wordnik.date.limit;
    console.log(chalk.white('Reset API limit to ' + c.wordnik.date.limit + '/' + c.wordnik.date.interval + '.'));
    c.wordnik.date.remain = c.wordnik.date.remain - 1;
    noon.save(CFILE, c);
  }
  if (c.wordnik.date.remain === 0) {
    proceed = false;
  } else if (c.wordnik.date.remain < 0) {
    proceed = false;
    c.wordnik.date.remain = 0;
    noon.save(CFILE, c);
  } else {
    proceed = true;
  }
  return [c, proceed, reset];
};

/**
  * Checks if a file exists
  * @private
  * @param {string} path The filename to check.
  * @return {boolean} fileExists
  */
function checkOutfile(path) {
  var fileExists = null;
  try {
    fs.statSync(path);
    fileExists = true;
  } catch (e) {
    if (e.code === 'ENOENT') {
      fileExists = false;
    }
  }
  return fileExists;
}

/**
  * Converts string to boolean
  * @public
  * @param {string} value
  * @return {boolean} v
  */
exports.checkBoolean = function (value) {
  var v = value;
  if (v === 'true') v = true;
  if (v === 'false') v = false;
  return v;
};

/**
  * Checks if config exists. If not, prints init message and exits with error code.
  * @public
  * @param {string} file Configuration filepath
  */
exports.checkConfig = function (file) {
  try {
    fs.statSync(file);
  } catch (e) {
    if (e.code === 'ENOENT') {
      throw new Error('No config found at ' + file + ', run: \'leximaven config init\'');
    }
  }
  return true;
};

/**
  * Checks if object is a single string in an array
  * @public
  * @param {Object} obj Any object
  * @return {Object} Original object or extracted string
  */
exports.arrToStr = function (obj) {
  var fixed = null;
  if (Array.isArray(obj) && obj.length === 1 && typeof obj[0] === 'string') {
    fixed = obj[0];
  } else {
    fixed = obj;
  }
  return fixed;
};

/**
  * Handles data export to file. Supports cson, json, noon, plist, xml, yaml.
  * @public
  * @param {string} path The desired filepath and extension
  * @param {boolean} force Whether to force overwrite
  * @param {Object} tofile A numbered object of data points
  */
exports.outFile = function (path, force, tofile) {
  var match = path.match(/\.([a-z]*)$/i);
  var ext = match[1];
  var builder = new xml2js.Builder();
  if (ext === 'xml') {
    if (checkOutfile(path)) {
      if (force) {
        var xml = builder.buildObject(tofile);
        var fd = fs.openSync(path, 'w+');
        fs.writeSync(fd, xml);
        fs.closeSync(fd);
        console.log(chalk.white('Overwrote ' + path + ' with data.'));
      } else {
        console.log(chalk.white(path + ' exists, use -f to force overwrite.'));
      }
    } else {
      var _xml = builder.buildObject(tofile);
      var _fd = fs.openSync(path, 'w+');
      fs.writeSync(_fd, _xml);
      fs.closeSync(_fd);
      console.log(chalk.white('Wrote data to ' + path + '.'));
    }
  } else if (ext === 'cson' || ext === 'json' || ext === 'noon' || ext === 'plist' || ext === 'yml' || ext === 'yaml') {
    if (checkOutfile(path)) {
      if (force) {
        noon.save(path, tofile);
        console.log(chalk.white('Overwrote ' + path + ' with data.'));
      } else {
        console.log(chalk.white(path + ' exists, use -f to force overwrite.'));
      }
    } else {
      noon.save(path, tofile);
      console.log(chalk.white('Wrote data to ' + path + '.'));
    }
  } else if (ext !== 'xml' || ext !== 'cson' || ext !== 'json' || ext !== 'noon' || ext !== 'plist' || ext !== 'yml' || ext !== 'yaml') throw new Error('Format ' + ext + ' not supported.');
};
//# sourceMappingURL=data:application/json;base64,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TSxRQUFRLFdBQVIsQ0FBb0IsTUFBcEIsQ0FBWjtBQUNBLFVBQU0sTUFBSyxHQUFHLFFBQUgsQ0FBWSxJQUFaLEVBQWtCLElBQWxCLENBQVg7QUFDQSxTQUFHLFNBQUgsQ0FBYSxHQUFiLEVBQWlCLElBQWpCO0FBQ0EsU0FBRyxTQUFILENBQWEsR0FBYjtBQUNBLGNBQVEsR0FBUixDQUFZLE1BQU0sS0FBTixvQkFBNkIsSUFBN0IsT0FBWjtBQUNEO0FBQ0YsR0FsQkQsTUFrQk8sSUFBSSxRQUFRLE1BQVIsSUFBa0IsUUFBUSxNQUExQixJQUFvQyxRQUFRLE1BQTVDLElBQXNELFFBQVEsT0FBOUQsSUFBeUUsUUFBUSxLQUFqRixJQUEwRixRQUFRLE1BQXRHLEVBQThHO0FBQ25ILFFBQUksYUFBYSxJQUFiLENBQUosRUFBd0I7QUFDdEIsVUFBSSxLQUFKLEVBQVc7QUFDVCxhQUFLLElBQUwsQ0FBVSxJQUFWLEVBQWdCLE1BQWhCO0FBQ0EsZ0JBQVEsR0FBUixDQUFZLE1BQU0sS0FBTixnQkFBeUIsSUFBekIsaUJBQVo7QUFDRCxPQUhELE1BR087QUFDTCxnQkFBUSxHQUFSLENBQVksTUFBTSxLQUFOLENBQWUsSUFBZix5Q0FBWjtBQUNEO0FBQ0YsS0FQRCxNQU9PO0FBQ0wsV0FBSyxJQUFMLENBQVUsSUFBVixFQUFnQixNQUFoQjtBQUNBLGNBQVEsR0FBUixDQUFZLE1BQU0sS0FBTixvQkFBNkIsSUFBN0IsT0FBWjtBQUNEO0FBQ0YsR0FaTSxNQVlBLElBQUksUUFBUSxLQUFSLElBQWlCLFFBQVEsTUFBekIsSUFBbUMsUUFBUSxNQUEzQyxJQUFxRCxRQUFRLE1BQTdELElBQXVFLFFBQVEsT0FBL0UsSUFBMEYsUUFBUSxLQUFsRyxJQUEyRyxRQUFRLE1BQXZILEVBQStILE1BQU0sSUFBSSxLQUFKLGFBQW9CLEdBQXBCLHFCQUFOO0FBQ3ZJLENBbkNEIiwiZmlsZSI6InRvb2xzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZXNsaW50IG1heC1sZW46IDAgKi9cbmNvbnN0IGNoYWxrID0gcmVxdWlyZSgnY2hhbGsnKVxuY29uc3QgZnMgPSByZXF1aXJlKCdmcycpXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKVxuY29uc3Qgbm9vbiA9IHJlcXVpcmUoJ25vb24nKVxuY29uc3QgeG1sMmpzID0gcmVxdWlyZSgneG1sMmpzJylcblxuY29uc3QgQ0ZJTEUgPSBgJHtwcm9jZXNzLmVudi5IT01FfS8ubGV4aW1hdmVuLm5vb25gXG5cbi8qKlxuICAqIFRoZSB0b29scyBtb2R1bGUgcHJvdmlkZXMgdXNlZnVsIHJlcGV0aXRpdmUgdGFza3NcbiAgKiBAbW9kdWxlIFV0aWxzXG4gICovXG5cbi8qKlxuICAqIE9uZWxvb2sncyBBUEkgbGltaXQgY2hlY2tcbiAgKiBAcGFyYW0gIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VycmVudCBjb25maWdcbiAgKiBAcmV0dXJuIHtBcnJheX0gVXBkYXRlZCBjb25maWcsIHByb2NlZWQgYm9vbGVhbiwgYW5kIHJlc2V0IGJvb2xlYW5cbiAgKi9cbmV4cG9ydHMubGltaXRPbmVsb29rID0gKGNvbmZpZykgPT4ge1xuICBjb25zdCBjID0gY29uZmlnXG4gIGxldCBwcm9jZWVkID0gZmFsc2VcbiAgbGV0IHJlc2V0ID0gZmFsc2VcbiAgY29uc3Qgc3RhbXAgPSBuZXcgRGF0ZShjLm9uZWxvb2suZGF0ZS5zdGFtcClcbiAgY29uc3QgaG91cnMgPSBtb21lbnQobmV3IERhdGUpLmRpZmYoc3RhbXAsICdob3VycycpXG4gIGlmIChob3VycyA8IDI0IHx8IGhvdXJzIDwgMCkge1xuICAgIGMub25lbG9vay5kYXRlLnJlbWFpbiA9IGMub25lbG9vay5kYXRlLnJlbWFpbiAtIDFcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH0gZWxzZSBpZiAoaG91cnMgPj0gMjQpIHtcbiAgICByZXNldCA9IHRydWVcbiAgICBjLm9uZWxvb2suZGF0ZS5zdGFtcCA9IG1vbWVudCgpLmZvcm1hdCgpXG4gICAgYy5vbmVsb29rLmRhdGUucmVtYWluID0gYy5vbmVsb29rLmRhdGUubGltaXRcbiAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgUmVzZXQgQVBJIGxpbWl0IHRvICR7Yy5vbmVsb29rLmRhdGUubGltaXR9LyR7Yy5vbmVsb29rLmRhdGUuaW50ZXJ2YWx9LmApKVxuICAgIGMub25lbG9vay5kYXRlLnJlbWFpbiA9IGMub25lbG9vay5kYXRlLnJlbWFpbiAtIDFcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH1cbiAgaWYgKGMub25lbG9vay5kYXRlLnJlbWFpbiA9PT0gMCkge1xuICAgIHByb2NlZWQgPSBmYWxzZVxuICB9IGVsc2UgaWYgKGMub25lbG9vay5kYXRlLnJlbWFpbiA8IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgICBjLm9uZWxvb2suZGF0ZS5yZW1haW4gPSAwXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjKVxuICB9IGVsc2Uge1xuICAgIHByb2NlZWQgPSB0cnVlXG4gIH1cbiAgcmV0dXJuIFtjLCBwcm9jZWVkLCByZXNldF1cbn1cblxuLyoqXG4gICogRGF0YW11c2UncyBBUEkgbGltaXQgY2hlY2tcbiAgKiBAcGFyYW0gIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VycmVudCBjb25maWdcbiAgKiBAcmV0dXJuIHtBcnJheX0gVXBkYXRlZCBjb25maWcsIHByb2NlZWQgYm9vbGVhbiwgYW5kIHJlc2V0IGJvb2xlYW5cbiAgKi9cbmV4cG9ydHMubGltaXREbXVzZSA9IChjb25maWcpID0+IHtcbiAgY29uc3QgYyA9IGNvbmZpZ1xuICBsZXQgcHJvY2VlZCA9IGZhbHNlXG4gIGxldCByZXNldCA9IGZhbHNlXG4gIGNvbnN0IHN0YW1wID0gbmV3IERhdGUoYy5kbXVzZS5kYXRlLnN0YW1wKVxuICBjb25zdCBob3VycyA9IG1vbWVudChuZXcgRGF0ZSkuZGlmZihzdGFtcCwgJ2hvdXJzJylcbiAgaWYgKGhvdXJzIDwgMjQpIHtcbiAgICBjLmRtdXNlLmRhdGUucmVtYWluID0gYy5kbXVzZS5kYXRlLnJlbWFpbiAtIDFcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH0gZWxzZSBpZiAoaG91cnMgPj0gMjQpIHtcbiAgICByZXNldCA9IHRydWVcbiAgICBjLmRtdXNlLmRhdGUuc3RhbXAgPSBtb21lbnQoKS5mb3JtYXQoKVxuICAgIGMuZG11c2UuZGF0ZS5yZW1haW4gPSBjLmRtdXNlLmRhdGUubGltaXRcbiAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgUmVzZXQgQVBJIGxpbWl0IHRvICR7Yy5kbXVzZS5kYXRlLmxpbWl0fS8ke2MuZG11c2UuZGF0ZS5pbnRlcnZhbH0uYCkpXG4gICAgYy5kbXVzZS5kYXRlLnJlbWFpbiA9IGMuZG11c2UuZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjKVxuICB9XG4gIGlmIChjLmRtdXNlLmRhdGUucmVtYWluID09PSAwKSB7XG4gICAgcHJvY2VlZCA9IGZhbHNlXG4gIH0gZWxzZSBpZiAoYy5kbXVzZS5kYXRlLnJlbWFpbiA8IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgICBjLmRtdXNlLmRhdGUucmVtYWluID0gMFxuICAgIG5vb24uc2F2ZShDRklMRSwgYylcbiAgfSBlbHNlIHtcbiAgICBwcm9jZWVkID0gdHJ1ZVxuICB9XG4gIHJldHVybiBbYywgcHJvY2VlZCwgcmVzZXRdXG59XG5cbi8qKlxuICAqIFJoeW1lYnJhaW4ncyBBUEkgbGltaXQgY2hlY2tcbiAgKiBAcGFyYW0gIHtPYmplY3R9IGNvbmZpZyBUaGUgY3VycmVudCBjb25maWdcbiAgKiBAcmV0dXJuIHtBcnJheX0gVXBkYXRlZCBjb25maWcsIHByb2NlZWQgYm9vbGVhbiwgYW5kIHJlc2V0IGJvb2xlYW5cbiAgKi9cbmV4cG9ydHMubGltaXRSYnJhaW4gPSAoY29uZmlnKSA9PiB7XG4gIGNvbnN0IGMgPSBjb25maWdcbiAgbGV0IHByb2NlZWQgPSBmYWxzZVxuICBsZXQgcmVzZXQgPSBmYWxzZVxuICBjb25zdCBzdGFtcCA9IG5ldyBEYXRlKGMucmJyYWluLmRhdGUuc3RhbXApXG4gIGNvbnN0IG1pbnV0ZXMgPSBtb21lbnQobmV3IERhdGUpLmRpZmYoc3RhbXAsICdtaW51dGVzJylcbiAgaWYgKG1pbnV0ZXMgPCA2MCkge1xuICAgIGMucmJyYWluLmRhdGUucmVtYWluID0gYy5yYnJhaW4uZGF0ZS5yZW1haW4gLSAxXG4gICAgbm9vbi5zYXZlKENGSUxFLCBjKVxuICB9IGVsc2UgaWYgKG1pbnV0ZXMgPj0gNjApIHtcbiAgICByZXNldCA9IHRydWVcbiAgICBjLnJicmFpbi5kYXRlLnN0YW1wID0gbW9tZW50KCkuZm9ybWF0KClcbiAgICBjLnJicmFpbi5kYXRlLnJlbWFpbiA9IGMucmJyYWluLmRhdGUubGltaXRcbiAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgUmVzZXQgQVBJIGxpbWl0IHRvICR7Yy5yYnJhaW4uZGF0ZS5saW1pdH0vJHtjLnJicmFpbi5kYXRlLmludGVydmFsfS5gKSlcbiAgICBjLnJicmFpbi5kYXRlLnJlbWFpbiA9IGMucmJyYWluLmRhdGUucmVtYWluIC0gMVxuICAgIG5vb24uc2F2ZShDRklMRSwgYylcbiAgfVxuICBpZiAoYy5yYnJhaW4uZGF0ZS5yZW1haW4gPT09IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgfSBlbHNlIGlmIChjLnJicmFpbi5kYXRlLnJlbWFpbiA8IDApIHtcbiAgICBwcm9jZWVkID0gZmFsc2VcbiAgICBjLnJicmFpbi5kYXRlLnJlbWFpbiA9IDBcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH0gZWxzZSB7XG4gICAgcHJvY2VlZCA9IHRydWVcbiAgfVxuICByZXR1cm4gW2MsIHByb2NlZWQsIHJlc2V0XVxufVxuXG4vKipcbiAgKiBXb3JkbmlrJ3MgQVBJIGxpbWl0IGNoZWNrXG4gICogQHBhcmFtICB7T2JqZWN0fSBjb25maWcgVGhlIGN1cnJlbnQgY29uZmlnXG4gICogQHJldHVybiB7QXJyYXl9IFVwZGF0ZWQgY29uZmlnLCBwcm9jZWVkIGJvb2xlYW4sIGFuZCByZXNldCBib29sZWFuXG4gICovXG5leHBvcnRzLmxpbWl0V29yZG5payA9IChjb25maWcpID0+IHtcbiAgY29uc3QgYyA9IGNvbmZpZ1xuICBsZXQgcHJvY2VlZCA9IGZhbHNlXG4gIGxldCByZXNldCA9IGZhbHNlXG4gIGNvbnN0IHN0YW1wID0gbmV3IERhdGUoYy53b3JkbmlrLmRhdGUuc3RhbXApXG4gIGNvbnN0IG1pbnV0ZXMgPSBtb21lbnQobmV3IERhdGUpLmRpZmYoc3RhbXAsICdtaW51dGVzJylcbiAgaWYgKG1pbnV0ZXMgPCA2MCkge1xuICAgIGMud29yZG5pay5kYXRlLnJlbWFpbiA9IGMud29yZG5pay5kYXRlLnJlbWFpbiAtIDFcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH0gZWxzZSBpZiAobWludXRlcyA+PSA2MCkge1xuICAgIHJlc2V0ID0gdHJ1ZVxuICAgIGMud29yZG5pay5kYXRlLnN0YW1wID0gbW9tZW50KCkuZm9ybWF0KClcbiAgICBjLndvcmRuaWsuZGF0ZS5yZW1haW4gPSBjLndvcmRuaWsuZGF0ZS5saW1pdFxuICAgIGNvbnNvbGUubG9nKGNoYWxrLndoaXRlKGBSZXNldCBBUEkgbGltaXQgdG8gJHtjLndvcmRuaWsuZGF0ZS5saW1pdH0vJHtjLndvcmRuaWsuZGF0ZS5pbnRlcnZhbH0uYCkpXG4gICAgYy53b3JkbmlrLmRhdGUucmVtYWluID0gYy53b3JkbmlrLmRhdGUucmVtYWluIC0gMVxuICAgIG5vb24uc2F2ZShDRklMRSwgYylcbiAgfVxuICBpZiAoYy53b3JkbmlrLmRhdGUucmVtYWluID09PSAwKSB7XG4gICAgcHJvY2VlZCA9IGZhbHNlXG4gIH0gZWxzZSBpZiAoYy53b3JkbmlrLmRhdGUucmVtYWluIDwgMCkge1xuICAgIHByb2NlZWQgPSBmYWxzZVxuICAgIGMud29yZG5pay5kYXRlLnJlbWFpbiA9IDBcbiAgICBub29uLnNhdmUoQ0ZJTEUsIGMpXG4gIH0gZWxzZSB7XG4gICAgcHJvY2VlZCA9IHRydWVcbiAgfVxuICByZXR1cm4gW2MsIHByb2NlZWQsIHJlc2V0XVxufVxuXG4vKipcbiAgKiBDaGVja3MgaWYgYSBmaWxlIGV4aXN0c1xuICAqIEBwcml2YXRlXG4gICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIGZpbGVuYW1lIHRvIGNoZWNrLlxuICAqIEByZXR1cm4ge2Jvb2xlYW59IGZpbGVFeGlzdHNcbiAgKi9cbmZ1bmN0aW9uIGNoZWNrT3V0ZmlsZShwYXRoKSB7XG4gIGxldCBmaWxlRXhpc3RzID0gbnVsbFxuICB0cnkge1xuICAgIGZzLnN0YXRTeW5jKHBhdGgpXG4gICAgZmlsZUV4aXN0cyA9IHRydWVcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICBmaWxlRXhpc3RzID0gZmFsc2VcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGZpbGVFeGlzdHNcbn1cblxuLyoqXG4gICogQ29udmVydHMgc3RyaW5nIHRvIGJvb2xlYW5cbiAgKiBAcHVibGljXG4gICogQHBhcmFtIHtzdHJpbmd9IHZhbHVlXG4gICogQHJldHVybiB7Ym9vbGVhbn0gdlxuICAqL1xuZXhwb3J0cy5jaGVja0Jvb2xlYW4gPSAodmFsdWUpID0+IHtcbiAgbGV0IHYgPSB2YWx1ZVxuICBpZiAodiA9PT0gJ3RydWUnKSB2ID0gdHJ1ZVxuICBpZiAodiA9PT0gJ2ZhbHNlJykgdiA9IGZhbHNlXG4gIHJldHVybiB2XG59XG5cbi8qKlxuICAqIENoZWNrcyBpZiBjb25maWcgZXhpc3RzLiBJZiBub3QsIHByaW50cyBpbml0IG1lc3NhZ2UgYW5kIGV4aXRzIHdpdGggZXJyb3IgY29kZS5cbiAgKiBAcHVibGljXG4gICogQHBhcmFtIHtzdHJpbmd9IGZpbGUgQ29uZmlndXJhdGlvbiBmaWxlcGF0aFxuICAqL1xuZXhwb3J0cy5jaGVja0NvbmZpZyA9IChmaWxlKSA9PiB7XG4gIHRyeSB7XG4gICAgZnMuc3RhdFN5bmMoZmlsZSlcbiAgfSBjYXRjaCAoZSkge1xuICAgIGlmIChlLmNvZGUgPT09ICdFTk9FTlQnKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYE5vIGNvbmZpZyBmb3VuZCBhdCAke2ZpbGV9LCBydW46ICdsZXhpbWF2ZW4gY29uZmlnIGluaXQnYClcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHRydWVcbn1cblxuLyoqXG4gICogQ2hlY2tzIGlmIG9iamVjdCBpcyBhIHNpbmdsZSBzdHJpbmcgaW4gYW4gYXJyYXlcbiAgKiBAcHVibGljXG4gICogQHBhcmFtIHtPYmplY3R9IG9iaiBBbnkgb2JqZWN0XG4gICogQHJldHVybiB7T2JqZWN0fSBPcmlnaW5hbCBvYmplY3Qgb3IgZXh0cmFjdGVkIHN0cmluZ1xuICAqL1xuZXhwb3J0cy5hcnJUb1N0ciA9IChvYmopID0+IHtcbiAgbGV0IGZpeGVkID0gbnVsbFxuICBpZiAoQXJyYXkuaXNBcnJheShvYmopICYmIG9iai5sZW5ndGggPT09IDEgJiYgdHlwZW9mIG9ialswXSA9PT0gJ3N0cmluZycpIHtcbiAgICBmaXhlZCA9IG9ialswXVxuICB9IGVsc2Uge1xuICAgIGZpeGVkID0gb2JqXG4gIH1cbiAgcmV0dXJuIGZpeGVkXG59XG5cbi8qKlxuICAqIEhhbmRsZXMgZGF0YSBleHBvcnQgdG8gZmlsZS4gU3VwcG9ydHMgY3NvbiwganNvbiwgbm9vbiwgcGxpc3QsIHhtbCwgeWFtbC5cbiAgKiBAcHVibGljXG4gICogQHBhcmFtIHtzdHJpbmd9IHBhdGggVGhlIGRlc2lyZWQgZmlsZXBhdGggYW5kIGV4dGVuc2lvblxuICAqIEBwYXJhbSB7Ym9vbGVhbn0gZm9yY2UgV2hldGhlciB0byBmb3JjZSBvdmVyd3JpdGVcbiAgKiBAcGFyYW0ge09iamVjdH0gdG9maWxlIEEgbnVtYmVyZWQgb2JqZWN0IG9mIGRhdGEgcG9pbnRzXG4gICovXG5leHBvcnRzLm91dEZpbGUgPSAocGF0aCwgZm9yY2UsIHRvZmlsZSkgPT4ge1xuICBjb25zdCBtYXRjaCA9IHBhdGgubWF0Y2goL1xcLihbYS16XSopJC9pKVxuICBjb25zdCBleHQgPSBtYXRjaFsxXVxuICBjb25zdCBidWlsZGVyID0gbmV3IHhtbDJqcy5CdWlsZGVyKClcbiAgaWYgKGV4dCA9PT0gJ3htbCcpIHtcbiAgICBpZiAoY2hlY2tPdXRmaWxlKHBhdGgpKSB7XG4gICAgICBpZiAoZm9yY2UpIHtcbiAgICAgICAgY29uc3QgeG1sID0gYnVpbGRlci5idWlsZE9iamVjdCh0b2ZpbGUpXG4gICAgICAgIGNvbnN0IGZkID0gZnMub3BlblN5bmMocGF0aCwgJ3crJylcbiAgICAgICAgZnMud3JpdGVTeW5jKGZkLCB4bWwpXG4gICAgICAgIGZzLmNsb3NlU3luYyhmZClcbiAgICAgICAgY29uc29sZS5sb2coY2hhbGsud2hpdGUoYE92ZXJ3cm90ZSAke3BhdGh9IHdpdGggZGF0YS5gKSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLndoaXRlKGAke3BhdGh9IGV4aXN0cywgdXNlIC1mIHRvIGZvcmNlIG92ZXJ3cml0ZS5gKSlcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgeG1sID0gYnVpbGRlci5idWlsZE9iamVjdCh0b2ZpbGUpXG4gICAgICBjb25zdCBmZCA9IGZzLm9wZW5TeW5jKHBhdGgsICd3KycpXG4gICAgICBmcy53cml0ZVN5bmMoZmQsIHhtbClcbiAgICAgIGZzLmNsb3NlU3luYyhmZClcbiAgICAgIGNvbnNvbGUubG9nKGNoYWxrLndoaXRlKGBXcm90ZSBkYXRhIHRvICR7cGF0aH0uYCkpXG4gICAgfVxuICB9IGVsc2UgaWYgKGV4dCA9PT0gJ2Nzb24nIHx8IGV4dCA9PT0gJ2pzb24nIHx8IGV4dCA9PT0gJ25vb24nIHx8IGV4dCA9PT0gJ3BsaXN0JyB8fCBleHQgPT09ICd5bWwnIHx8IGV4dCA9PT0gJ3lhbWwnKSB7XG4gICAgaWYgKGNoZWNrT3V0ZmlsZShwYXRoKSkge1xuICAgICAgaWYgKGZvcmNlKSB7XG4gICAgICAgIG5vb24uc2F2ZShwYXRoLCB0b2ZpbGUpXG4gICAgICAgIGNvbnNvbGUubG9nKGNoYWxrLndoaXRlKGBPdmVyd3JvdGUgJHtwYXRofSB3aXRoIGRhdGEuYCkpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgJHtwYXRofSBleGlzdHMsIHVzZSAtZiB0byBmb3JjZSBvdmVyd3JpdGUuYCkpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vb24uc2F2ZShwYXRoLCB0b2ZpbGUpXG4gICAgICBjb25zb2xlLmxvZyhjaGFsay53aGl0ZShgV3JvdGUgZGF0YSB0byAke3BhdGh9LmApKVxuICAgIH1cbiAgfSBlbHNlIGlmIChleHQgIT09ICd4bWwnIHx8IGV4dCAhPT0gJ2Nzb24nIHx8IGV4dCAhPT0gJ2pzb24nIHx8IGV4dCAhPT0gJ25vb24nIHx8IGV4dCAhPT0gJ3BsaXN0JyB8fCBleHQgIT09ICd5bWwnIHx8IGV4dCAhPT0gJ3lhbWwnKSB0aHJvdyBuZXcgRXJyb3IoYEZvcm1hdCAke2V4dH0gbm90IHN1cHBvcnRlZC5gKVxufVxuIl19